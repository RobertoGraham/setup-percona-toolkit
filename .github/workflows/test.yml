name: Test

on:
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: bitnami/mysql:8.4.4
        env:
          ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: setup_percona_toolkit
        ports:
          - 3306:3306
        volumes:
          - ${{ github.workspace }}/test:/docker-entrypoint-startdb.d
        options: >-
          --name mysql
          --health-cmd /opt/bitnami/scripts/mysql/healthcheck.sh
          --health-interval 15s
          --health-timeout 5s
          --health-retries 6
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # https://github.com/actions/checkout/releases/tag/v4.2.2

      - name: Restart MySQL
        uses: docker://docker
        with:
          args: docker restart mysql

      - name: Set up Percona Toolkit
        uses: ./

      - name: Use pt-online-schema-change
        shell: bash
        run: >-
          pt-online-schema-change
          --execute
          --alter 'ADD COLUMN test INT'
          --host localhost
          --user root
          --password ''
          D=setup_percona_toolkit,t=test
